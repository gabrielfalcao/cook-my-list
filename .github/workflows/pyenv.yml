name: 🐍 Scraper Engine

defaults:
  run:
    working-directory: ./scraper-engine

on:
  push:
    branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  build:
    name: "Python Tests"
    runs-on: ubuntu-latest
    env:
      POSTGRES_PASSWORD: scraper_engine
      POSTGRES_USER: scraper_engine
      POSTGRES_DB: scraper_engine
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      ELASTICSEARCH_HOST: elasticsearch
      ALEMBIC_CONFIG: /tmp/alembic.ini
    strategy:
      matrix:
        python:
          - 3.7.5
    services:
      elasticsearch:
        image: elasticsearch:7.12.1

      postgres:
        image: postgres:13
        env:  # env needs to be duplicated here or else github fails
          POSTGRES_PASSWORD: scraper_engine
          POSTGRES_USER: scraper_engine
          POSTGRES_DB: scraper_engine
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
        options: >-
          --health-cmd pg_isready
          --health-interval 1s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v2

    - name: setup pyenv
      uses: gabrielfalcao/pyenv-action@v7
      with:
        default: "${{ matrix.python }}"

    - name: install dependencies
      run: make develop setup

    - name: cache .venv
      id: cache-venv
      uses: actions/cache@v1
      with:
        path: .venv
        key: ${{ runner.os }}-${{ hashFiles('*.txt') }}-python3.7

    - name: run unit tests
      run: make unit

    - name: run db migrations
      run: make db-migrate

    - name: run functional tests
      run: make functional

    - name: "Upload coverage results to codecov.io"
      uses: codecov/codecov-action@v1
      with:
        file: ./coverage.xml # optional
